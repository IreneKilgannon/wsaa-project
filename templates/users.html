<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    
    <!--Bootstrap CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!--Awesome font-->
    <script src="https://kit.fontawesome.com/e8de472ad4.js" crossorigin="anonymous"></script>

    
</head>
<body>
    
    <div class="container p-5 my-5 bg-light border-primary">
        <h1>Users</h1>
        <hr>
        <div id="alert-placeholder"></div>
        <nav class="navbar navbar-expand-sm navbar-light" style="background-color: #99caee;">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav mr-auto mt-2 mt-lg-0">                
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('index') }}">Sewing Patterns</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="{{ url_for('users') }}">Users</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('about') }}">About</a>
                </li>
              </ul>
            </div>
          </nav>
        <br><br>
        <div><button class="btn btn-secondary border-dark" id="button-showCreateUser" onclick="showCreateUser()">Get your userID!</button></div><br>
        
        <!--Form to Enter UserID-->
        <h2>Enter User ID</h2>
        <form id="userIdForm">
          <input type="text" id="userIdInput" name="user_id" placeholder="Enter User ID" required>
          <button type="submit">View User</button>
        </form>



        <table class="table table-striped" id="userTable" style="display: none;">
            <thead >
                <tr>
                    <th class="table-success">UserID &nbsp;&#x2b83;</th>
                    <th class="table-success">First Name &nbsp;&#x2b83;</th>
                    <th class="table-success">Last Name &nbsp;&#x2b83;</th>
                    <th class="table-success">Email &nbsp;&#x2b83;</th>
                    <th class="table-success">Password</th>
                    <th class="table-success">Update</th>
                    <th class="table-success">Delete</th>
                </tr>
            </thead>
            <tbody>
                  
            </tbody>
        </table>
            
    <form id="createUserUpdateForm" style="display:none" onsubmit="return false;">
        <!-- Form for creating  and updating users -->
        <h2><span id="createLabel">Become a </span>User<span id="updateLabel">Update</span> User</h2>
        <input type="hidden" name="userID" autocomplete="off">
        First Name<br><input type="text" name="first_name" required><br/>
        Last Name<br><input type="text" name="last_name" required><br/>
        Email<br><input type="email"name="email" required ><br/>
        Password<br><input type="password" name="password" required><br/><br>
        <!--Confirm Password<br><input type="password" name="confirmPassword" required><br/>
            <br><br>-->
        <span><button class="btn btn-secondary border-dark" id="button-doCreateUser" onclick="doCreateUser()">Register</button></span>
        <span><button class="btn btn-secondary border-dark" id="button-doUpdateUser" onclick="doUserUpdate()">Update</button></span>
    </form>

    <div id="loginForm" style="display:none;">
        <h2>Login</h2>
        Email<br><input type="email" id="loginEmail" required><br>
        Password<br><input type="password" id="loginPassword" required><br><br>
        <button class="btn btn-primary" onclick="doLogin()">Login</button>
    </div>
    
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
</body>

<script>
    function showCreateUser(){
        document.getElementById("createUserUpdateForm").style.display = "block";
        document.getElementById("button-doCreateUser").style.display = "block";
        document.getElementById("button-doUpdateUser").style.display = "none";
        document.getElementById("createLabel").style.display = "inline";
        document.getElementById("updateLabel").style.display = "none";
        document.getElementById("button-showCreateUser").style.display = "none";
        document.getElementById("userTable").style.display = "none";
        //document.getElementById("myInput").style.display = "none";
    }

    function showViewAllUsers(){
        console.log('Showing view all')
        document.getElementById("createUserUpdateForm").style.display = "none"
        document.getElementById("button-showCreateUser").style.display = "block"
        document.getElementById("userTable").style.display = "block"
    }

    function showUserUpdate(buttonElement){
        //console.log('Updating user...');
        document.getElementById("createUserUpdateForm").style.display = "block";
        document.getElementById("button-doCreateUser").style.display = "none";
        document.getElementById("button-doUpdateUser").style.display = "block";
        document.getElementById("createLabel").style.display = "none";
        document.getElementById("updateLabel").style.display = "inline";
        document.getElementById("button-showCreateUser").style.display = "none";
        document.getElementById("userTable").style.display = "none";
        //document.getElementById("myInput").style.display = "none";
        var rowElement= buttonElement.parentNode.parentNode;
        var user = getUserFromRow(rowElement);
        console.log('User to update:', user);
        //console.log(User)
        populateFormWithUser(user);
    }

    function doCreateUser(){
        
        var form = document.getElementById('createUserUpdateForm')

        if (!form.checkValidity()) {
        form.reportValidity();
        return;
        }

        var user = {}
        user.first_name = form.querySelector('input[name="first_name"]').value
        user.last_name = form.querySelector('input[name="last_name"]').value
        user.email = form.querySelector('input[name="email"]').value
        user.password = form.querySelector('input[name="password"]').value
        //user.confirmPassword = form.querySelector('input[name="confirmPassword"]').value
        console.log(JSON.stringify(user))
        createUserAjax(user);
    }

    function doUserUpdate(){
        var form = document.getElementById('createUserUpdateForm')

        if (!form.checkValidity()) {
        form.reportValidity();
        return;
        }

        console.log("in update")
        var user = getUserFromForm();

        //var form = document.getElementById('createUserUpdateForm');
        
        var rowElement = document.querySelector(`[userID='${user.userID}']`);
        if (rowElement) {
            updateUserAjax(user);
            setUserInRow(rowElement, user);
            clearUserForm();
            showViewAllUsers();
        } else {
            console.log('Row element not found')
        }
    }

    function doUserDelete(r){
        console.log("in delete")
        var tableElement = document.getElementById('userTable');
        var rowElement = r.parentNode.parentNode;
        var index = rowElement.rowIndex;
        
        console.log("deleting "+ rowElement.getAttribute("userID"))
        deleteUserAjax(rowElement.getAttribute("userID"));
        tableElement.deleteRow(index);
        showViewAllUsers()
    }
    
    function addUserToTable(user){
        console.log("DEBUG USER to table:", user);
        var tableElement = document.getElementById('userTable').querySelector('tbody');
        console.log("Adding user to table:", user);
        var rowElement = tableElement.insertRow(-1)
        
        rowElement.setAttribute('userID', user.userID)
        
        var cell1 = rowElement.insertCell(0);
        cell1.innerHTML = user.userID
        var cell2 = rowElement.insertCell(1);
        cell2.innerHTML = user.first_name
        var cell3 = rowElement.insertCell(2);
        cell3.innerHTML = user.last_name
        var cell4 = rowElement.insertCell(3);
        cell4.innerHTML = user.email
        var cell5 = rowElement.insertCell(4);
        cell5.innerHTML = '********'
        var cell6 = rowElement.insertCell(5);
        cell6.innerHTML = '<button class="btn btn-outline-primary" onclick="showUserUpdate(this)">Update</button>'
        var cell7 = rowElement.insertCell(6);
        cell7.innerHTML = '<button class="btn btn-outline-danger" onclick="doUserDelete(this)">Delete</button>'
    }

    function clearUserTable() {
        document.getElementById('userTable').querySelector('tbody').innerHTML = '';
    }

    function clearUserForm(){
        var form = document.getElementById('createUserUpdateForm')

        form.querySelector('input[name="first_name"]').value=''
        form.querySelector('[name="last_name"]').value =''
        form.querySelector('[name="email"]').value= ''
        form.querySelector('input[name="password"]').value=''
    }

    function getUserFromRow(rowElement){
        var user ={}

        user.userID  = rowElement.getAttribute('userID')
        user.first_name = rowElement.cells[1].textContent;
        user.last_name = rowElement.cells[2].textContent;
        user.email = rowElement.cells[3].textContent;
        //user.password = rowElement.cells[4].textContent;
        return user
    }

    function setUserInRow(rowElement, user){
        rowElement.cells[0].firstChild.textContent = user.userID;
        rowElement.cells[1].firstChild.textContent = user.first_name;
        rowElement.cells[2].firstChild.textContent = user.last_name;
        rowElement.cells[3].firstChild.textContent = user.email;
        //rowElement.cells[4].firstChild.textContent = user.password;
    }

    function populateFormWithUser(user){
        console.log("Populating form with user:", user);
        var form = document.getElementById('createUserUpdateForm');
        form.querySelector('input[name="userID"]').disabled = true;
        
        form.querySelector('input[name="userID"]').value  = user.userID;
        form.querySelector('input[name="first_name"]').value= user.first_name;
        form.querySelector('input[name="last_name"]').value = user.last_name;
        form.querySelector('input[name="email"]').value= user.email;
        form.querySelector('input[name= "password"]').value = '';
        return user;
    }

    function getUserFromForm(){
        var form = document.getElementById('createUserUpdateForm')
        var user = {}
        
        user.userID = form.querySelector('input[name="userID"]').value
        user.first_name = form.querySelector('input[name="first_name"]').value
        user.last_name = form.querySelector('[name="last_name"]').value
        user.email = form.querySelector('[name="email"]').value
        user.password = form.querySelector('[name="password"]').value
        console.log(JSON.stringify(user))
        return user
    }

        document.getElementById('userIdForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent page reload
        
        let userId = document.getElementById('userIdInput').value.trim();
        if (!userId) return;
        
        $.ajax({
            url: '/users/' + encodeURIComponent(userId),
            method: 'GET',
            dataType: 'json',
            success: function(user) {
                // Clear table
                const table = document.getElementById('userTable');
                table.querySelector('tbody').innerHTML = '';
                addUserToTable(user);
                table.style.display = 'table';
            },
            error: function(xhr) {
                alert('User not found with ID: ' + userId);
                document.getElementById('userTable').style.display = 'none';
            }
        });
    });


    function getAllUserAjax(){
        $.ajax({
            "url": "/users",
            "method":"GET",
            "data":"",
            "dataType": "JSON",
            "success":function(result){
                console.log(result);
                for (user of result){
                    addUserToTable(user);
                }
            },
            "error":function(xhr,status,error){
                //console.log("error: "+status+" msg:"+error);
                //console.log("Response text: " +xhr.responseText)
            }
        });
    }

    function createUserAjax(user){
        console.log("Test" , JSON.stringify(user)); 
        $.ajax({
            "url": "/users",
            "method":"POST",
            "data":JSON.stringify(user),
            "dataType": "JSON",
            "contentType": "application/json; charset=utf-8",
            "success":function(result){
                user.userID = result.userID
                addUserToTable(result);
                clearUserForm();
                showViewAllUsers();
                
                alert("Welcome " + result.first_name +". Your userID is: " +result.userID);
        },
            "error":function(xhr,status,error){
                //console.log("error: "+status+" msg:"+error);
            }
        });
    }
    function updateUserAjax(user){
        console.log(JSON.stringify(user));
        $.ajax({
            "url": "/users/"+encodeURI(user.userID),
            "method":"PUT",
            "data":JSON.stringify(user),
            "dataType": "JSON",
            "contentType": "application/json; charset=utf-8",
            "success":function(result){
                console.log(result);
            
            },
            "error":function(xhr,status,error){
                console.log("error: "+status+" msg:"+error);
            }
        });
    }
    function deleteUserAjax(userID){
        $.ajax({
            "url": "/users/"+encodeURI(userID),
            "method":"DELETE",
            "data":"",
            "dataType": "JSON",
            "contentType": "application/json; charset=utf-8",
            "success":function(result){
                //console.log(result);

            },
            "error":function(xhr,status,error){
                console.log("error: "+status+" msg:"+error);
            }
        });
    }

    // Don't display the table at first
    getAllUserAjax();

    </script>
</html>